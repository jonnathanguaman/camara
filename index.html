<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de C√°mara para Formulario</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        .seccion {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .seccion h3 {
            margin-top: 0;
            color: #fff;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }
        
        video {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 10px;
            margin: 20px auto;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        canvas {
            display: none;
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        button.danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }
        
        .fotos-container {
            min-height: 60px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .grid-responsive {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± Sistema de C√°mara para Formulario</h1>
        
        <div class="info">
            <strong>üìã Instrucciones:</strong><br>
            ‚Ä¢ Haz clic en "Abrir C√°mara" para cada secci√≥n<br>
            ‚Ä¢ Captura hasta 3 fotos por secci√≥n<br>
            ‚Ä¢ Las fotos se guardar√°n autom√°ticamente<br>
            ‚Ä¢ Puedes eliminar fotos individuales con el bot√≥n ‚ùå
        </div>

        <form id="formulario-principal" method="post" action="#" onsubmit="return validarFormulario()">
            <!-- Secci√≥n A - Fotos generales -->
            <div class="seccion">
                <h3>üè† Secci√≥n A - Fotos Generales</h3>
                <div class="controls">
                    <button type="button" onclick="abrirCamara('')">üì∑ Abrir C√°mara</button>
                </div>
                <video id="video" autoplay playsinline muted></video>
                <canvas id="canvas"></canvas>
                <div id="fotos-tomadas" class="fotos-container"></div>
            </div>

            <!-- Secci√≥n B - Fotos del producto -->
            <div class="seccion">
                <h3>üì¶ Secci√≥n B - Fotos del Producto</h3>
                <div class="controls">
                    <button type="button" onclick="abrirCamaraB()">üì∑ Abrir C√°mara</button>
                </div>
                <video id="videoB" autoplay playsinline muted></video>
                <canvas id="canvasB"></canvas>
                <div id="fotos-tomadasB" class="fotos-container"></div>
            </div>

            <!-- Secci√≥n C - Evidencia de temperatura -->
            <div class="seccion">
                <h3>üå°Ô∏è Secci√≥n C - Evidencia de Temperatura</h3>
                <div class="controls">
                    <button type="button" onclick="abrirCamaraC()">üì∑ Abrir C√°mara</button>
                </div>
                <video id="videoC" autoplay playsinline muted></video>
                <canvas id="canvasC"></canvas>
                <div id="fotos-tomadasC" class="fotos-container"></div>
            </div>

            <!-- Secci√≥n D - Evidencia de al√©rgenos -->
            <div class="seccion">
                <h3>‚ö†Ô∏è Secci√≥n D - Evidencia de Al√©rgenos</h3>
                <div class="controls">
                    <button type="button" onclick="abrirCamaraD()">üì∑ Abrir C√°mara</button>
                </div>
                <video id="videoD" autoplay playsinline muted></video>
                <canvas id="canvasD"></canvas>
                <div id="fotos-tomadasD" class="fotos-container"></div>
            </div>

            <!-- Ejemplo de campos de condiciones para cada secci√≥n -->
            <div class="seccion">
                <h3>üìù Condiciones y Observaciones</h3>
                
                <div class="grid-responsive">
                    <!-- Condiciones Secci√≥n A -->
                    <div>
                        <h4>Secci√≥n A</h4>
                        <input type="text" name="condicion_A_0" placeholder="Condici√≥n 1" style="margin: 5px; padding: 8px; width: 90%; border-radius: 5px; border: none;">
                        <select name="cumple_A_0" style="margin: 5px; padding: 8px; border-radius: 5px; border: none;">
                            <option value="">Seleccionar</option>
                            <option value="SI">Cumple</option>
                            <option value="NO">No Cumple</option>
                        </select>
                        
                        <input type="text" name="condicion_A_1" placeholder="Condici√≥n 2" style="margin: 5px; padding: 8px; width: 90%; border-radius: 5px; border: none;">
                        <select name="cumple_A_1" style="margin: 5px; padding: 8px; border-radius: 5px; border: none;">
                            <option value="">Seleccionar</option>
                            <option value="SI">Cumple</option>
                            <option value="NO">No Cumple</option>
                        </select>
                    </div>

                    <!-- Condiciones Secci√≥n B -->
                    <div>
                        <h4>Secci√≥n B</h4>
                        <input type="text" name="condicion_B_0" placeholder="Condici√≥n 1" style="margin: 5px; padding: 8px; width: 90%; border-radius: 5px; border: none;">
                        <select name="cumple_B_0" style="margin: 5px; padding: 8px; border-radius: 5px; border: none;">
                            <option value="">Seleccionar</option>
                            <option value="SI">Cumple</option>
                            <option value="NO">No Cumple</option>
                        </select>
                    </div>

                    <!-- Condiciones Secci√≥n C -->
                    <div>
                        <h4>Secci√≥n C</h4>
                        <input type="text" name="condicion_C_0" placeholder="Condici√≥n 1" style="margin: 5px; padding: 8px; width: 90%; border-radius: 5px; border: none;">
                        <select name="cumple_C_0" style="margin: 5px; padding: 8px; border-radius: 5px; border: none;">
                            <option value="">Seleccionar</option>
                            <option value="SI">Cumple</option>
                            <option value="NO">No Cumple</option>
                        </select>
                    </div>

                    <!-- Condiciones Secci√≥n D -->
                    <div>
                        <h4>Secci√≥n D</h4>
                        <input type="text" name="condicion_D_0" placeholder="Condici√≥n 1" style="margin: 5px; padding: 8px; width: 90%; border-radius: 5px; border: none;">
                        <select name="cumple_D_0" style="margin: 5px; padding: 8px; border-radius: 5px; border: none;">
                            <option value="">Seleccionar</option>
                            <option value="SI">Cumple</option>
                            <option value="NO">No Cumple</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="controls" style="margin-top: 30px;">
                <button type="submit" style="background: linear-gradient(45deg, #007bff, #0056b3); font-size: 18px; padding: 15px 30px;">
                    üíæ Enviar Formulario
                </button>
            </div>
        </form>
    </div>

    <script>
// C√≥digo de c√°mara para formulario de recepci√≥n

// Funci√≥n para validar el formulario antes del env√≠o
function validarFormulario() {
    if (typeof window.guardarFirma === 'function') {
        return window.guardarFirma();
    } else {
        alert("Error: La funci√≥n de firma no est√° disponible.");
        return false;
    }
}

// Variables globales
const streams = {};
const fotoContadores = {};
const fotosCapturadas = {
    'A': [],
    'B': [],
    'C': [],
    'D': []
};

// Configuraci√≥n de botones
const btnStyles = {
    capturar: `margin-top: 15px; padding: 10px 20px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
            color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); margin-right: 10px;`,
    cerrar: `margin-top: 15px; padding: 10px 20px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); 
            color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);`
};

const secciones = {
    '': { color: '#667eea', titulo: 'üì∑ Fotos capturadas:' },
    'B': { color: '#fd7e14', titulo: 'üì∑ Fotos del producto:' },
    'C': { color: '#17a2b8', titulo: 'üì∑ Evidencia de temperatura:' },
    'D': { color: '#6f42c1', titulo: 'üì∑ Evidencia de al√©rgenos:' }
};

// Funci√≥n universal para abrir c√°mara
async function abrirCamara(sufijo = '') {
    const video = document.getElementById(`video${sufijo}`);
    
    if (!video) {
        console.error(`Video element with id 'video${sufijo}' not found`);
        return;
    }
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment', 
                width: { ideal: 1280 }, 
                height: { ideal: 720 } 
            },
            audio: false
        });
        
        streams[sufijo] = stream;
        video.srcObject = stream;
        
        // Asegurar que el video se muestre en el div actual, no en ventana emergente
        video.style.cssText = `
            display: block !important;
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 8px;
            border: 2px solid #007bff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin: 10px 0;
            position: relative;
            z-index: 1;
        `;
        
        // Esperar a que el video est√© listo antes de mostrar botones
        video.onloadedmetadata = () => {
            video.play();
            crearBotones(sufijo, video.parentNode);
        };
        
    } catch (err) {
        console.error('Error al acceder a la c√°mara:', err);
        alert('Error al acceder a la c√°mara: ' + err.message);
    }
}

// Crear botones din√°micamente
function crearBotones(sufijo, parent) {
    if (!document.getElementById(`btn-capturar${sufijo}`)) {
        const btnCapturar = crearBoton(`btn-capturar${sufijo}`, 'üì∏ CAPTURAR', btnStyles.capturar, () => capturarFoto(sufijo));
        const btnCerrar = crearBoton(`btn-cerrar${sufijo}`, '‚ùå CERRAR', btnStyles.cerrar, () => cerrarCamara(sufijo));
        parent.appendChild(btnCapturar);
        parent.appendChild(btnCerrar);
    }
}

// Crear bot√≥n con estilo y eventos
function crearBoton(id, texto, estilo, onclick) {
    const btn = document.createElement('button');
    btn.id = id;
    btn.innerHTML = texto;
    btn.style.cssText = estilo;
    btn.onclick = onclick;
    btn.type = 'button'; // Importante para evitar submit del formulario
    btn.onmouseover = () => btn.style.transform = 'translateY(-2px)';
    btn.onmouseout = () => btn.style.transform = 'translateY(0)';
    return btn;
}

// Funci√≥n universal para capturar foto
function capturarFoto(sufijo = '') {
    const seccion = sufijo || 'A';
    
    // Verificar si ya se han capturado 3 fotos en esta secci√≥n
    const fotosValidas = fotosCapturadas[seccion].filter(foto => foto !== null);
    if (fotosValidas.length >= 3) {
        alert(`M√°ximo 3 fotos permitidas por secci√≥n. Ya has capturado ${fotosValidas.length} fotos en esta secci√≥n.`);
        return;
    }
    
    const video = document.getElementById(`video${sufijo}`);
    const canvas = document.getElementById(`canvas${sufijo}`);
    const ctx = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    
    // Obtener datos de la imagen
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    
    // Guardar en el array correspondiente
    const fotoIndex = fotosCapturadas[seccion].length;
    fotosCapturadas[seccion].push(imageData);
                
                // Crear contenedor para la foto con bot√≥n de eliminar
                const fotoContainer = document.createElement('div');
                fotoContainer.style.cssText = `display: inline-block; position: relative; margin: 5px;`;
                fotoContainer.id = `foto-container-${seccion}-${fotoIndex}`;
                
                const img = document.createElement('img');
                img.src = imageData;
                img.style.cssText = `max-width: 120px; border: 2px solid ${secciones[sufijo].color}; 
                                    border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; display: block;`;
                img.onmouseover = () => img.style.transform = 'scale(1.05)';
                img.onmouseout = () => img.style.transform = 'scale(1)';
                
                // Crear bot√≥n de eliminar
                const btnEliminar = document.createElement('button');
                btnEliminar.innerHTML = '‚ùå';
                btnEliminar.type = 'button';
                btnEliminar.style.cssText = `position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; 
                                            border-radius: 50%; background: #dc3545; color: white; border: none; 
                                            cursor: pointer; font-size: 12px; display: flex; align-items: center; 
                                            justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                            transition: background-color 0.2s;`;
                btnEliminar.title = 'Eliminar foto';
                btnEliminar.onclick = () => eliminarFoto(seccion, fotoIndex);
                btnEliminar.onmouseover = () => btnEliminar.style.backgroundColor = '#c82333';
                btnEliminar.onmouseout = () => btnEliminar.style.backgroundColor = '#dc3545';
                
                fotoContainer.appendChild(img);
                fotoContainer.appendChild(btnEliminar);
                
                fotoContadores[sufijo] = (fotoContadores[sufijo] || 0) + 1;
                const divFotos = document.getElementById(`fotos-tomadas${sufijo}`);
                
                if (fotoContadores[sufijo] === 1) {
                    const fotosRestantes = 3 - fotosValidas.length - 1; // -1 porque acabamos de agregar una
                    const contadorTexto = fotosRestantes > 0 ? ` (${fotosRestantes} fotos restantes)` : ' (l√≠mite alcanzado)';
                    divFotos.innerHTML = `<div style="color: #495057; font-weight: 600; margin-bottom: 10px;">${secciones[sufijo].titulo}${contadorTexto}</div>`;
                } else {
                    // Actualizar el contador en el t√≠tulo
                    const tituloDiv = divFotos.querySelector('div:first-child');
                    if (tituloDiv) {
                        const fotosRestantes = 3 - fotosValidas.length - 1; // -1 porque acabamos de agregar una
                        const contadorTexto = fotosRestantes > 0 ? ` (${fotosRestantes} fotos restantes)` : ' (l√≠mite alcanzado)';
                        tituloDiv.innerHTML = `${secciones[sufijo].titulo}${contadorTexto}`;
                    }
                }
                
                divFotos.appendChild(fotoContainer);
            }

            // Funci√≥n para eliminar foto
            function eliminarFoto(seccion, fotoIndex) {
                // Confirmar eliminaci√≥n
                if (confirm('¬øEst√° seguro de que desea eliminar esta foto?')) {
                    // Eliminar del DOM
                    const fotoContainer = document.getElementById(`foto-container-${seccion}-${fotoIndex}`);
                    if (fotoContainer) {
                        fotoContainer.remove();
                    }
                    
                    // Eliminar del array de fotos capturadas
                    if (fotosCapturadas[seccion] && fotosCapturadas[seccion][fotoIndex]) {
                        fotosCapturadas[seccion][fotoIndex] = null; // Marcar como eliminada
                    }
                    
                    // Verificar si quedan fotos en esta secci√≥n
                    const fotosRestantes = fotosCapturadas[seccion].filter(foto => foto !== null);
                    
                    // Buscar el div de fotos correcto seg√∫n la secci√≥n
                    let divFotosId = 'fotos-tomadas';
                    if (seccion && seccion !== 'A') {
                        divFotosId = `fotos-tomadas${seccion}`;
                    }
                    
                    const divFotos = document.getElementById(divFotosId);
                    
                    if (divFotos && fotosRestantes.length === 0) {
                        // Si no quedan fotos, limpiar completamente el contenedor
                        divFotos.innerHTML = '';
                        fotoContadores[seccion] = 0;
                    } else if (divFotos && fotosRestantes.length > 0) {
                        // Actualizar el contador en el t√≠tulo
                        const tituloDiv = divFotos.querySelector('div:first-child');
                        if (tituloDiv) {
                            const fotosDisponibles = 3 - fotosRestantes.length;
                            const contadorTexto = fotosDisponibles > 0 ? ` (${fotosDisponibles} fotos restantes)` : ' (l√≠mite alcanzado)';
                            const sufijo = seccion === 'A' ? '' : seccion;
                            tituloDiv.innerHTML = `${secciones[sufijo].titulo}${contadorTexto}`;
                        }
                    }
                }
            }

            // Funci√≥n universal para cerrar c√°mara
            function cerrarCamara(sufijo = '') {
                // Detener todas las pistas del stream
                if (streams[sufijo]) {
                    streams[sufijo].getTracks().forEach(track => {
                        track.stop();
                        console.log(`Track ${track.kind} detenido`);
                    });
                    delete streams[sufijo];
                }
                
                // Limpiar el video element
                const video = document.getElementById(`video${sufijo}`);
                if (video) {
                    video.srcObject = null;
                    video.style.display = 'none';
                }
                
                // Remover botones
                const btnCapturar = document.getElementById(`btn-capturar${sufijo}`);
                const btnCerrar = document.getElementById(`btn-cerrar${sufijo}`);
                if (btnCapturar) btnCapturar.remove();
                if (btnCerrar) btnCerrar.remove();
                
                console.log(`C√°mara ${sufijo} cerrada correctamente`);
            }

            // Funciones espec√≠ficas (mantienen compatibilidad)
            const abrirCamaraB = () => abrirCamara('B');
            const abrirCamaraC = () => abrirCamara('C');
            const abrirCamaraD = () => abrirCamara('D');

            // Preparar datos antes del env√≠o del formulario
            function prepararDatosFormulario() {
                const form = document.querySelector('form');
                
                // Agregar campos hidden para las fotos - formato individual que espera el controlador
                Object.keys(fotosCapturadas).forEach(seccion => {
                    let fotoIndexValida = 0;
                    fotosCapturadas[seccion].forEach((foto, index) => {
                        // Solo procesar fotos que no han sido eliminadas (no son null)
                        if (foto !== null) {
                            // Crear un campo hidden por cada foto
                            const inputFoto = document.createElement('input');
                            inputFoto.type = 'hidden';
                            inputFoto.name = `foto_${seccion}_${fotoIndexValida}`;
                            inputFoto.value = foto.replace('data:image/jpeg;base64,', '');
                            form.appendChild(inputFoto);
                            
                            // Agregar nombre de la foto
                            const inputNombre = document.createElement('input');
                            inputNombre.type = 'hidden';
                            inputNombre.name = `foto_${seccion}_${fotoIndexValida}_nombre`;
                            inputNombre.value = `Foto_${seccion}_${fotoIndexValida + 1}`;
                            form.appendChild(inputNombre);
                            
                            // Agregar descripci√≥n de la foto
                            const inputDesc = document.createElement('input');
                            inputDesc.type = 'hidden';
                            inputDesc.name = `foto_${seccion}_${fotoIndexValida}_descripcion`;
                            inputDesc.value = `Evidencia secci√≥n ${seccion}`;
                            form.appendChild(inputDesc);
                            
                            fotoIndexValida++;
                        }
                    });
                });

                // Agregar datos de condiciones (solo las que tienen texto)
                ['A', 'B', 'C', 'D'].forEach(seccion => {
                    let condicionIndex = 0;
                    const condiciones = [];
                    
                    while (true) {
                        const condicionInput = document.querySelector(`input[name="condicion_${seccion}_${condicionIndex}"]`);
                        const cumpleSelect = document.querySelector(`select[name="cumple_${seccion}_${condicionIndex}"]`);
                        
                        if (!condicionInput) break;
                        
                        if (condicionInput.value.trim()) {
                            condiciones.push({
                                condicion: condicionInput.value.trim(),
                                cumple: cumpleSelect ? cumpleSelect.value : '',
                                observacion: ''
                            });
                        }
                        
                        condicionIndex++;
                    }
                    
                    if (condiciones.length > 0) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = `condiciones_${seccion}`;
                        input.value = JSON.stringify(condiciones);
                        form.appendChild(input);
                    }
                });
            }

// Eventos DOM
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[style*="grid-template-columns"]').forEach(el => el.classList.add('grid-responsive'));
    document.querySelectorAll('table').forEach(el => el.classList.add('table-responsive'));
    
    // Agregar evento al formulario para preparar datos antes del env√≠o
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            prepararDatosFormulario();
        });
    }
});
    </script>
</body>
</html>
